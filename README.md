<h2 align="center">Зажигание на PIC12F675 для 2-х тактного двигателя.</h2>

### Папки и файлы:

    Doc     файл со схемой китайского CDI (взят входной каскад), файл с кривой из документации и xmls с макросом для построения кривой.
    Hard    Электронные схемы двух версий CDI и печатная плата для 2-й версии, а также фото готового устройства.
    Soft    Файлы с программой на Си (MPLAB Xpress & XC8 compiler), а также прошивка для PIC12F675.
    README.md  Этот файл.
---
### Первый этап - разработка схемы

В сети нашел схему китайского [CDI](https://github.com/nva1773/Ignition-for-2-stroke-engine/blob/master/Doc/CDI-AC-DC.jpg).
Из нее взял входной узел для отрицательного импульса. В качестве МК был выбран PIC12F675, маленький и самое главное был в наличии.
С начала была разработанна [первая](https://github.com/nva1773/Ignition-for-2-stroke-engine/blob/master/Hard/sch1.jpg) версия для входного сигнала с первым отрицательным импульсом, но сняв осциллограмму с реального 
индуктивного датчика (первый положительный) появился [второй](https://github.com/nva1773/Ignition-for-2-stroke-engine/blob/master/Hard/sch2.jpg) вариант. Также у них есть различия для цепей питания и выключения двигателя.
В первом варианте питание от высоковольтной катушки, а во втором от бортовой сети 12В. Т.к. у мотоцикла Yamaha DT125 есть мощносной клапан, блоку управления которым нужент высоковольтный импульс для расчета скорости вращения ротора, то во второй схеме сигнал "Kill switch" выполняет двоякую функцию (выключение двигателя и управление мощносным клапаном).

### Второй этап - построение кривой

Для автоматизации построения кривой и получения выходных данных для CPU (задержка выдачи управляющего импульса) была созданя [таблица](https://github.com/nva1773/Ignition-for-2-stroke-engine/blob/master/Doc/Ignition-Yamaha-DT125-65deg.xlsm) с макросом, который нужен для упрощения получения данных в виде списка значений в текстовом виде.

Угол опережения для первого импульса вносим в ячейку "B3", делее заполняем колонку "Ignition (deg) from datasheet" данными об угле опережения для соответствующей скорости вращения ротора. Нажав кнопку "angleDeg[64]={}" в ячейке "Q5" получаем данные которые нужно вставить в соответствующий массив в файле [cdi.c](https://github.com/nva1773/Ignition-for-2-stroke-engine/blob/master/Soft/cdi.c).
Значение ячейки "O66" присваеваем определителю "DELAY_MIN" в файле [header.h](https://github.com/nva1773/Ignition-for-2-stroke-engine/blob/master/Soft/header.h).

### Третий этап - получения прошивки

Программа была написанна в бесплатной среде разработки от Microchip [MPLAB Xpress](https://mplabxpress.microchip.com/mplabcloud/ide) на Си и скопилированна бесплатным копилятором XC8. Сам процесс создания проекта очень прост, регистрируемся на сайте, нажимаем кнопку "New project", выбираем проект "Standalone project" нажимаем "Next", вибараем CPU введя в поле "Device" PIC12F675 нажимаем "Next", вводим имя проекта (например: CDI) и жмем "Finish". В свойствах проекта выбираем компилятор "XC8". Импортируем Header (.h) и Source (.c) файлы и собираем проект нажав "Build Project". После компиляции нажимаем "Make and Program Device" в результате чего на комьютер загузится файл с прошивкой (cdi.hex).

### Последний этап - сборка

Печатная [плата](https://github.com/nva1773/Ignition-for-2-stroke-engine/blob/master/Hard/pcb.jpg) была резведенна только для второго варианта. После изготовления и испытания плата была залита эпоксидной смолой. В результате получили вот такое устройство:

![CDI](https://github.com/nva1773/Ignition-for-2-stroke-engine/blob/master/Hard/foto.jpg)
